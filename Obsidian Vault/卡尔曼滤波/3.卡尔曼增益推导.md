# 协方差矩阵
$$
\boldsymbol{X}_k=\boldsymbol{A}\boldsymbol{X}_{k-1}+\boldsymbol{B}\boldsymbol{u}_k+\boldsymbol{w}_{k-1}
$$
$$
\boldsymbol{Z}_k=\boldsymbol{H}\boldsymbol{X}_k+\boldsymbol{v}_k
$$
一般噪声（过程噪声、测量噪声）属于正态分布：$p(\boldsymbol{w})\textasciitilde N(0,\boldsymbol{Q})$，0是期望，$\boldsymbol{Q}$是协方差矩阵，其中$\boldsymbol{Q}=E[\boldsymbol{ww}^T]$，例如：
$$
\boldsymbol{Q}=E\left[\begin{bmatrix}w_1\\w_2\end{bmatrix}\begin{bmatrix}w_1&w_2\end{bmatrix}\right]=
\begin{bmatrix}
Ew_1^2&Ew_1w_2\\Ew_2w_1&Ew_2^2
\end{bmatrix}\
$$
又有方差$var(x)=E(x^2)-E^2(x)$，而噪声的期望$E(x)=0$，所以$var(x)=E(x^2)$，故有：
$$
\boldsymbol{Q}=
\begin{bmatrix}
\sigma_{w_1}^2&\sigma_{w_1}\sigma_{w_2}\\
\sigma_{w_2}\sigma_{w_1}&\sigma_{w_2}^2
\end{bmatrix}
$$
# 先验估计和后验估计
由于无法对噪声建模，所以有先验估计，也就是算出来的结果：
$$
\hat{\boldsymbol{X}}_k^-=\boldsymbol{A}\hat{\boldsymbol{X}}_{k-1}+\boldsymbol{B}\boldsymbol{u}_{k-1}
$$
测出来的结果：
$$
\hat{\boldsymbol{X}}_{k_{mean}}=\boldsymbol{H}^{-1}\boldsymbol{Z}_k
$$
使用卡尔曼滤波得到后验估计：
$$
\hat{\boldsymbol{X}_k}=\hat{\boldsymbol{X}}_k^-+\boldsymbol{G}(\boldsymbol{H}^{-1}\boldsymbol{Z}_k-\hat{\boldsymbol{X}}_k^-)
\quad,\boldsymbol{G}=(0,1)
$$
常见的另一种形式：
$$
\hat{\boldsymbol{X}_k}=\hat{\boldsymbol{X}}_k^-+K_k(\boldsymbol{Z}_k-\boldsymbol{H}\hat{\boldsymbol{X}}_k^-)
\quad,K_k=(0,\boldsymbol{H}^{-1})
$$
目标：寻找$K_k$，使得后验估计$\hat{\boldsymbol{X}}_k$趋近真实值$\boldsymbol{X}_k$，引入后验误差
$$
\boldsymbol{e}_k=\boldsymbol{X}_k-\hat{\boldsymbol{X}}_k
$$
其中$p(\boldsymbol{e}_k)\textasciitilde(0,\boldsymbol{P}_K)$，$\boldsymbol{P}_k$为协方差矩阵，求卡尔曼增益使后验估计最准确，就是使后验误差最小，也就是求协方差矩阵的迹最小（各项值方差之和最小），后验估计协方差矩阵
$$
\begin{align}
\boldsymbol{P}_k&=E[\boldsymbol{e}_k\boldsymbol{e}_k^T]\\
&=E[(\boldsymbol{X}_k-\hat{\boldsymbol{X}}_k)(\boldsymbol{X}_k-\hat{\boldsymbol{X}}_k)^T]
\end{align}
$$
又有
$$
\begin{align}
\boldsymbol{X}_k-\hat{\boldsymbol{X}}_k&=\boldsymbol{X}_k-[\hat{\boldsymbol{X}}_k^-+K_k(\boldsymbol{Z}_k-\boldsymbol{H}\hat{\boldsymbol{X}}_k^-)]\\
&=\boldsymbol{X}_k-\hat{\boldsymbol{X}}_k^--K_k\boldsymbol{Z}_k+K_k\boldsymbol{H}\hat{\boldsymbol{X}}_k^-\\
&\xlongequal{\boldsymbol{Z}_k=\boldsymbol{H}\boldsymbol{X}_k+\boldsymbol{v}_k}(\boldsymbol{I}-K_k\boldsymbol{H})(\boldsymbol{X}_k-\hat{\boldsymbol{X}}_k^-)-K_k\boldsymbol{v}_k\\
&\xlongequal{\boldsymbol{e}_k^-=\boldsymbol{X}_k-\hat{\boldsymbol{X}}_k^-}(\boldsymbol{I}-K_k\boldsymbol{H})\boldsymbol{e}_k^--K_k\boldsymbol{v}_k
\end{align}
$$
所以
$$
\begin{align}
\boldsymbol{P}_k&=E\left[[(\boldsymbol{I}-K_k\boldsymbol{H})\boldsymbol{e}_k^--K_k\boldsymbol{v}_k][(\boldsymbol{I}-K_k\boldsymbol{H})\boldsymbol{e}_k^--K_k\boldsymbol{v}_k]^T\right]\\
&=E\left[(\boldsymbol{I}-K_k\boldsymbol{H})\boldsymbol{e}_k^-{\boldsymbol{e}_k^-}^T(\boldsymbol{I}-K_k\boldsymbol{H})^T-(\boldsymbol{I}-K_k\boldsymbol{H})\boldsymbol{e}_k^-{\boldsymbol{v}_k}^T{K_k}^T-K_k\boldsymbol{v}_k{\boldsymbol{e}_k^-}^T(\boldsymbol{I}-K_k\boldsymbol{H})^T+K_k\boldsymbol{v}_k{\boldsymbol{v}_k}^T{K_k}^T\right]\\
&=(\boldsymbol{I}-K_k\boldsymbol{H})E\left[\boldsymbol{e}_k^-{\boldsymbol{e}_k^-}^T\right](\boldsymbol{I}-K_k\boldsymbol{H})^T-(\boldsymbol{I}-K_k\boldsymbol{H})E\left[\boldsymbol{e}_k^-\right]E\left[{\boldsymbol{v}_k}^T\right]{K_k}^T-K_kE\left[\boldsymbol{v}_k\right]E\left[{\boldsymbol{e}_k^-}^T\right](\boldsymbol{I}-K_k\boldsymbol{H})^T+K_kE\left[\boldsymbol{v}_k{\boldsymbol{v}_k}^T\right]{K_k}^T\\
&\xlongequal{E\left[\boldsymbol{v}_k\right]=0,E\left[\boldsymbol{e}_k^-\right]=0,\boldsymbol{P}_k^-=E\left[\boldsymbol{e}_k^-{\boldsymbol{e}_k^-}^T\right],\boldsymbol{R}=E\left[\boldsymbol{v}_k{\boldsymbol{v}_k}^T\right]}(\boldsymbol{I}-K_k\boldsymbol{H})\boldsymbol{P}_k^-(\boldsymbol{I}-K_k\boldsymbol{H})^T-0-0+K_k\boldsymbol{R}{K_k}^T\\
&=\boldsymbol{P}_k^--K_k\boldsymbol{H}\boldsymbol{P}_k^--\boldsymbol{P}_k^-\boldsymbol{H}^TK_k^T+K_k\boldsymbol{H}\boldsymbol{P}_k^-\boldsymbol{H}^TK_k^T+K_k\boldsymbol{R}K_k^T
\end{align}
$$
求迹
$$
\begin{align}
tr(\boldsymbol{P}_k)&=tr(\boldsymbol{P}_k^-)-tr(K_k\boldsymbol{H}\boldsymbol{P}_k^-)-tr(\boldsymbol{P}_k^-\boldsymbol{H}^TK_k^T)+tr(K_k\boldsymbol{H}\boldsymbol{P}_k^-\boldsymbol{H}^TK_k^T)+tr(K_k\boldsymbol{R}K_k^T)\\
&\xlongequal{tr(K_k\boldsymbol{H}\boldsymbol{P}_k^-)=tr(\boldsymbol{P}_k^-\boldsymbol{H}^TK_k^T)}tr(\boldsymbol{P}_k^-)-2tr(K_k\boldsymbol{H}\boldsymbol{P}_k^-)+tr(K_k\boldsymbol{H}\boldsymbol{P}_k^-\boldsymbol{H}^TK_k^T)+tr(K_k\boldsymbol{R}K_k^T)
\end{align}
$$
对迹求导
$$
\frac{dtr(\boldsymbol{P}_k)}{dK_k}\xlongequal{\frac{dtr(\boldsymbol{AB})}{d\boldsymbol{A}}=\boldsymbol{B}^T,\frac{dtr(\boldsymbol{ABA}^T)}{d\boldsymbol{A}}=2\boldsymbol{AB}}0-2(\boldsymbol{HP}_k^-)^T+2K_k\boldsymbol{HP}_k^-\boldsymbol{H}^T+2K_k\boldsymbol{R}
$$
令其为零
$$
\begin{align}
{\boldsymbol{P}_k^-}^T\boldsymbol{H}^T&=K_k(\boldsymbol{HP}_k^-\boldsymbol{H}^T+\boldsymbol{R})\\
K_k&\xlongequal{\boldsymbol{P}_k^-={\boldsymbol{P}_k^-}^T}\frac{\boldsymbol{P_k^-}\boldsymbol{H}^T}{\boldsymbol{HP}_k^-\boldsymbol{H}^T+\boldsymbol{R}}
\end{align}
$$